### 目的
积累下我们曾经遇到过的 「基础设施」 故障以及积累下处理的过程，寻求其间的优化空间

### 模板
#### 时间指标
复盘以下时间是否存在优化空间，是否达到了 SLA
- 故障感知时间
- 故障响应时间
- 故障处理时间

####  故障描述
- 事故回放
- 事故影响
  - 用户侧: 用户直接感受到的影响
  - 服务侧: 服务端受到的表现
  - 产品侧: 对产品核心指标的影响
- 事故原因
   - 直接原因
   - 间接原因

#### 改进方案
- 短期方案
- 长期方案
- 其他风险点


### 举个例子
# Redis 误操作复盘
## 时间指标
- 故障感知时间: 30m 不符合预期
- 故障响应时间: 5m 符符预期,
- 故障处理时间: 1h

## 故障描述
#### 事故回放
- `2021-03-19 11:46` 准备好主从复制的使用的实例

#### 事故影响
##### 用户侧
- 在 `2021-03-19 12:00 ~ 2021-03-19 12:30` 间用户无法使用关注功能
- 在 `2021-03-19 12:30 ~ 2021-03-19 13:00` 间用户无法查看正确的粉丝数

##### 服务侧
- 在 `2021-03-19 12:00 ~ 2021-03-19 12:30` 间服务平均可用率低于 90%
- 在 `2021-03-19 12:00 ~ 2021-03-19 12:30` 间服务平均可用率低于 98%

##### 产品侧
- 降低当天 Zapee 使用时长 1m

#### 事故原因
##### 直接原因
- 没有遵守操作资源的规范

##### 间接原因
- Redis Client 刷新拓扑节点的信息参数没有生效

## 改进方案
### 短期方案
- 遵守操作规范

### 长期方案
- 列出所有需要生效参数的服务, 逐步生效参数

### 其他风险点
- 暂无



# 以下是示例

# 时间指标

- 故障感知时间：5m
- 故障响应时间：1m
- 故障处理时间：2h

# 故障描述

## 事故回放

- 在 `2021-03-19 11:45` jianxin 为 Snaptube 推荐系统/用户画像的「缓存集群」做高可用配置；
- 在 `2021-03-19 11:45` jianxin 开始对集群进行操作；
- 在 `2021-03-19 11:48` 从「[监控观测](http://grafana.mobiu.space/d/rJdFOXOiz/redis-status?orgId=1&from=1616122415833&to=1616148697685&var-business_group=snaptube-rcmd&var-cluster=prod-st-rcmd-userprf&var-addr=prod-st-rcmd-userprf.001.redis.meta.aws:6379)」到缓存集群负载下降，初步判断应该是对「缓存集群」的操作导致服务异常
- 在 `2021-03-19 11:50` jianxin 回滚了对缓存集群的配置，但是缓存服务的负载依旧没有恢复至操作前的正常范围
- 在 `2021-03-19 12:00 ~ 2021-03-19 13:05` 从监控观测到系统负载升高，导致该实例上的缓存服务无法正常提供服务
- 在 `2021-03-19 13:09` 收到缓存服务不可用的告警
- 在 `2021-03-19 13:09 ~ 2021-03-19 14:02`经 heyang、jianxin 排查，问题是 jianxin 在回滚对集群的配置之后，没有及时停止缓存服务用于备份数据的「bgsave 进程」，导致该进程持续占用大量的内存
- 在 `2021-03-19 14:06` 缓存服务负载恢复至正常范围

## 事故影响

### 用户侧

- 在 `2021-03-19 11:50 ~ 2021-03-19 14:02` 间推送给用户的部分视频，不是最新的

### 服务侧

- 在 `2021-03-19 11:50 ~ 2021-03-19 14:02` 间调用「user-profile」，如果 key 未命中，返回 `NULL`

### 产品侧

- 无明显影响

## 事故原因

### 直接原因

- 缓存集群主从配置回滚之后，没有及时停止「bgsave 进程」，导致占用大量资源，造成该实例上的缓存服务不可用；

### 间接原因

- 对缓存服务的原理了解还不够；
- 没有严格执行 SRE 的公约规范进行操作；
- 没有提前和业务方沟通，在业务低峰期执行该操作；
- 对缓存集群的操作不当，导致服务异常一直存在，没有彻底消除；

## 改进方案

### 短期方案

- 严格遵守执行 SRE 规范和公约，做好 “关键性检查/Check”；
- 提前和业务方沟通维护的时间，避免在业务高峰期对线上服务基础设施的维护操作；
- 对提供给线上服务基础设施的维护操作，提前和业务方做好沟通，让业务方有个预期；

### 长期方案

- 持续对自己所负责的基础设施做原理性的学习和了解；

### 其他风险点

- 暂无